<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>SQL on ZDoc</title><link>https://til.rdz.io/docs/sql/</link><description>Recent content in SQL on ZDoc</description><generator>Hugo -- gohugo.io</generator><language>en</language><copyright>&amp;copy;{year}, All Rights Reserved</copyright><lastBuildDate>Thu, 04 Nov 2021 16:36:47 -0400</lastBuildDate><atom:link href="https://til.rdz.io/docs/sql/index.xml" rel="self" type="application/rss+xml"/><item><title>Get Waiting Tasks</title><link>https://til.rdz.io/docs/sql/waiting-tasks/</link><pubDate>Sat, 06 Nov 2021 16:13:01 -0400</pubDate><guid>https://til.rdz.io/docs/sql/waiting-tasks/</guid><description>Get Waiting Tasks 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 /*============================================================================ File: WaitingTasks.sql Summary: Snapshot of waiting tasks SQL Server Versions: 2005 onward ------------------------------------------------------------------------------ Written by Paul S.</description></item><item><title>SQL User Administration</title><link>https://til.rdz.io/docs/sql/sql-user-administration/</link><pubDate>Sat, 06 Nov 2021 16:07:57 -0400</pubDate><guid>https://til.rdz.io/docs/sql/sql-user-administration/</guid><description>Adding SQL Users and Logins Sql Auth Master Login and User 1 2 3 4 5 6 7 8 9 10 11 12 -- create SQL auth login from master CREATELOGINtestWITHPASSWORD=&amp;#39;SuperSecret!&amp;#39;-- select your db in the dropdown and create a user mapped to a login CREATEUSER[test]FORLOGIN[test]WITHDEFAULT_SCHEMA=dbo;-- add user to role(s) in db ALTERROLEdb_datareaderADDMEMBER[test];ALTERROLEdb_datawriterADDMEMBER[test]; Sql Auth Contained User 1 2 3 4 5 6 7 8 -- select your db in dropdown and create a contained user CREATEUSER[test]WITHPASSWORD=&amp;#39;SuperSecret!</description></item><item><title>Get Database Info</title><link>https://til.rdz.io/docs/sql/get-database-info/</link><pubDate>Sat, 06 Nov 2021 15:55:46 -0400</pubDate><guid>https://til.rdz.io/docs/sql/get-database-info/</guid><description>Get Database Sizes 1 2 3 4 5 6 7 8 9 10 11 12 13 14 SELECT[DatabaseName]=DB_NAME(database_id),[Type]=CASEWHENType_Desc=&amp;#39;ROWS&amp;#39;THEN&amp;#39;Data File(s)&amp;#39;WHENType_Desc=&amp;#39;LOG&amp;#39;THEN&amp;#39;Log File(s)&amp;#39;ELSE&amp;#39;Combined Total&amp;#39;END,[SizeinMB]=CAST(((SUM(Size)*8)/1024.0)ASDECIMAL(18,2))FROMsys.master_files--WHERE database_id = DB_ID(‘Database Name’) GROUPBYGROUPINGSETS((DB_NAME(database_id),Type_Desc),(DB_NAME(database_id)))ORDERBYDB_NAME(database_id),Type_DescDESCGO List all Database filenames and locations 1 2 3 4 5 6 7 8 9 SELECTdb.nameASDBName,mf.nameASFileName,type_descASFileType,Physical_NameASLocationFROMsys.master_filesmfINNERJOINsys.databasesdbONdb.database_id=mf.database_id List CLR References 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 SELECTso.</description></item><item><title>Backup/Restore Monitoring</title><link>https://til.rdz.io/docs/sql/get-backup-or-restore-status/</link><pubDate>Sat, 06 Nov 2021 15:54:26 -0400</pubDate><guid>https://til.rdz.io/docs/sql/get-backup-or-restore-status/</guid><description>Get Backup or Restore Status Execute the following query to get the current backup or restore status with estimated completion time.
1 2 3 4 5 6 7 8 9 SELECTsession_idASSPID,command,a.TEXTASQuery,start_time,percent_complete,dateadd(second,estimated_completion_time/1000,getdate())ASestimated_completion_timeFROMsys.dm_exec_requestsrCROSSAPPLYsys.dm_exec_sql_text(r.sql_handle)aWHEREr.commandIN(&amp;#39;BACKUP DATABASE&amp;#39;,&amp;#39;RESTORE DATABASE&amp;#39;)</description></item><item><title>Troubleshooting</title><link>https://til.rdz.io/docs/sql/troubleshooting/</link><pubDate>Sat, 06 Nov 2021 15:52:52 -0400</pubDate><guid>https://til.rdz.io/docs/sql/troubleshooting/</guid><description>Find blocking spids/queries Use the following script if not using sp_blitzwho or sp_whoisactive
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 -- List down all the blocking process or root blockers SELECTDISTINCTp1.spidAS[Blocking/RootBlockerSPID],p1.[loginame]AS[RootBlocker_Login],st.textAS[SQLQueryText],p1.[CPU],p1.[Physical_IO],DB_NAME(p1.[dbid])ASDBName,p1.[Program_name],p1.[HostName],p1.[Status],p1.[CMD],p1.[Blocked],p1.[ECID]AS[ExecutionContextID]FROMsys.sysprocessesp1INNERJOINsys.sysprocessesp2ONp1.spid=p2.blockedANDp1.ecid=p2.ecidCROSSAPPLYsys.dm_exec_sql_text(p1.sql_handle)stWHEREp1.blocked=0ORDERBYp1.spid,p1.ecid-- List Down all the blocked processes SELECTp2.spidAS&amp;#39;Blocked SPID&amp;#39;,p2.blockedAS&amp;#39;Blocking/Root Blocker SPID&amp;#39;,p2.[loginame]AS[BlockedSPID_Login],st.textAS[SQLQueryText],p2.[CPU],p2.[Physical_IO],DB_NAME(p2.[dbid])ASDBName,p2.[Program_name],p2.[HostName],p2.[Status],p2.[CMD],p2.ECIDAS[ExecutionContextID]FROMsys.sysprocessesp1INNERJOINsys.sysprocessesp2ONp1.spid=p2.blockedANDp1.ecid=p2.ecidCROSSAPPLYsys.dm_exec_sql_text(p1.sql_handle)st Find connections and running queries List all active connections sp_who2 active - Bultin not much details sp_whoIsActive - Much more detailed lots of filtering options Download Link sp_BlitzWho - Great Detail takes a bit longer to execute.</description></item><item><title>Drop All Tables</title><link>https://til.rdz.io/docs/sql/drop-all-tables-azure-sql/</link><pubDate>Sat, 06 Nov 2021 15:46:35 -0400</pubDate><guid>https://til.rdz.io/docs/sql/drop-all-tables-azure-sql/</guid><description>Drop all tables (Azure Sql Compatible) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 DECLARE@sqlNVARCHAR(2000)WHILE(EXISTS(SELECT1fromINFORMATION_SCHEMA.TABLE_CONSTRAINTSWHERECONSTRAINT_TYPE=&amp;#39;FOREIGN KEY&amp;#39;))BEGINSELECTTOP1@sql=(&amp;#39;ALTER TABLE &amp;#39;+TABLE_SCHEMA+&amp;#39;.[&amp;#39;+TABLE_NAME+&amp;#39;] DROP CONSTRAINT [&amp;#39;+CONSTRAINT_NAME+&amp;#39;]&amp;#39;)FROMINFORMATION_SCHEMA.TABLE_CONSTRAINTSWHERECONSTRAINT_TYPE=&amp;#39;FOREIGN KEY&amp;#39;EXEC(@sql)PRINT@sqlENDWHILE(EXISTS(SELECT*fromINFORMATION_SCHEMA.TABLESWHERETABLE_NAME!=&amp;#39;__MigrationHistory&amp;#39;ANDTABLE_NAME!=&amp;#39;database_firewall_rules&amp;#39;))BEGINSELECTTOP1@sql=(&amp;#39;DROP TABLE &amp;#39;+TABLE_SCHEMA+&amp;#39;.[&amp;#39;+TABLE_NAME+&amp;#39;]&amp;#39;)FROMINFORMATION_SCHEMA.TABLESWHERETABLE_NAME!=&amp;#39;__MigrationHistory&amp;#39;ANDTABLE_NAME!=&amp;#39;database_firewall_rules&amp;#39;EXEC(@sql)PRINT@sqlEND</description></item><item><title>External Table Creation</title><link>https://til.rdz.io/docs/sql/create-external-tables-scripted/</link><pubDate>Thu, 04 Nov 2021 16:42:54 -0400</pubDate><guid>https://til.rdz.io/docs/sql/create-external-tables-scripted/</guid><description>External Table Creation Script Use the following script to create external tables in Azure SQL. Execute in the source DB to parse all tables into the scripts needed to create the external tables.
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 Declare@table_namenvarchar(256)DECLARE@db_namevarchar(max)SET@table_name=&amp;#39;&amp;#39;WHILE@table_nameISNOTNULLBEGINSET@table_name=(SELECTMIN(TABLE_SCHEMA+&amp;#39;.</description></item><item><title>Linked Servers</title><link>https://til.rdz.io/docs/sql/linked-servers/</link><pubDate>Thu, 04 Nov 2021 16:41:09 -0400</pubDate><guid>https://til.rdz.io/docs/sql/linked-servers/</guid><description>Add Login Mapping to Linked Server Mapped Login to Remote SQL Login 1 2 3 4 5 6 7 8 USE[master]GOEXECmaster.dbo.sp_addlinkedsrvlogin@rmtsrvname=N&amp;#39;&amp;lt;SERVER NAME&amp;gt;&amp;#39;,@locallogin=N&amp;#39;&amp;lt;LOCAL LOGIN&amp;gt;&amp;#39;,@useself=N&amp;#39;False&amp;#39;,@rmtuser=N&amp;#39;&amp;lt;REMOTE LOGIN&amp;gt;&amp;#39;,@rmtpassword=N&amp;#39;&amp;lt;REMOTE PASSWORD&amp;gt;&amp;#39; User Impersonation 1 2 3 4 5 6 USE[master]GOEXECmaster.dbo.sp_addlinkedsrvlogin@rmtsrvname=N&amp;#39;&amp;lt;SERVER NAME&amp;gt;&amp;#39;,@locallogin=N&amp;#39;&amp;lt;LOCAL LOGIN&amp;gt;&amp;#39;,@useself=N&amp;#39;True&amp;#39; Detailed Linked Server Report 1 2 3 4 SELECT*FROMsys.ServersaLEFTOUTERJOINsys.linked_loginsbONb.server_id=a.server_idLEFTOUTERJOINsys.server_principalscONc.principal_id=b.local_principal_id Find SQL Linked Server Depdendencies 1 2 3 4 5 6 7 8 9 10 SELECTDistinctreferenced_Server_nameAsLinkedServerName,referenced_schema_nameASLinkedServerSchema,referenced_database_nameASLinkedServerDB,referenced_entity_nameAsLinkedServerTable,OBJECT_NAME(referencing_id)ASObjectUsingLinkedServerFROMsys.sql_expression_dependenciesJOINsys.objectsoono.object_id=referencing_id-- WHERE o.name = &amp;#39;&amp;lt;VIEW / SPROC NAME&amp;gt;&amp;#39; --UNCOMMENT TO FILTER ON SPECIFIC VIEW OR SPROC</description></item></channel></rss>